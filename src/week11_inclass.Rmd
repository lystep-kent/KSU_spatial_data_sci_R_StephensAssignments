---
title: "Week 11 in-class activities"
output: html_notebook
---

```{r}
library(tidyverse)
library(terra)
library(sf)
library(tmap)
```



Let's read a raster image   

```{r}
myras <- terra::rast("../data/ts_2016.1007_1013.L4.LCHMP3.CIcyano.MAXIMUM_7day.tif")
```

plot it
```{r}
plot(myras)
```


Basic properties

```{r}
terra::ext(myras)

terra::nlyr(myras)

terra::ncol(myras)

terra::nrow(myras)

terra::ncell(myras)


# to demonstrate that arithmetic works
ncol(myras) * nrow(myras) == ncell(myras)

```

QUESTION: what's the data structure of a raster file?


Get values by index
```{r}
myras[1]


myras[33961]

```

Or by row, column
```{r}

#[row, column]  
myras[132, 164]
```

### Two questions:

1. How is "single indexing" different than row, column indexing?
2. For row, column indexing, what other information is useful/required to know what you're doing?



Frequency of values 
```{r}

terra::freq(myras)
  

```
What's the output???


Let's use it to make a quick histogram


```{r}
terra::freq(myras) %>%  
  ggplot(., aes(x = value, y = count)) +
  geom_bar(stat = "identity")
```

Was the plot useful? Why or why not?



Let's try again
```{r}
terra::freq(myras) %>%
  dplyr::filter(value < 252) %>% 
  ggplot(., aes(x = value, y = count)) +
  geom_bar(stat = "identity")
```
Better?


Another way to "get" cell values
```{r}
myras %>% terra::values(.) %>%
  head(10)
```
Perhaps not the most useful for printing to the console, but does demonstrate how to access raw data values

## Raster aggregation

### Why might we want to change the resolution of a raster?

Let's break down the code
```{r}
terra::aggregate(myras, 2, fun = max)
```
What happened?



More obvious comparisons
```{r}
terra::aggregate(myras, 2, fun = max) %>% plot()
terra::aggregate(myras, 5, fun = max) %>% plot()
```
Interpret the results. How do they differ in spatial scale, generalization, etc.?


Different functions lead to different results
```{r}
raster::aggregate(myras, 5, fun = max) %>% plot()
raster::aggregate(myras, 5, fun = mean) %>% plot()
```

Again, how do they differ?


## Data conversions

Let's turn some cells into points
```{r}
myras %>% terra::as.points()
```
What's the data structure returned?


Maybe try plotting it?

```{r}
myras %>% terra::as.points() %>% plot()
```
What are we seeing?

We can also polygonize (if we'd like)
```{r}
poly1 <- terra::as.polygons(myras, dissolve = T)

tmap_mode("view")
tm_shape(poly1) + tm_polygons()
```
Zoom in. What do you see? What was the result?


Might be more obvious if we aggregate first
```{r}
myras %>% 
  terra::aggregate(., 3, fun = max) %>%
  terra::as.polygons(., dissolve = T) %>%
  tm_shape(.) + 
  tm_polygons()
```

